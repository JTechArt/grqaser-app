# Story 8.4: Library auto-add on open, manual remove

## Status

Draft

## Story

**As a** mobile user,
**I want** every book I open to be added automatically to the Library section, and to be able to remove items from the Library manually if I choose,
**so that** my Library reflects what I've opened and I can tidy it when I want.

## Acceptance Criteria

1. **Auto-add:** When the user opens a book (e.g., opens book detail or starts playback), that book is added to the Library section automatically; no separate "Add to Library" action is required for adding.
2. **Manual remove:** User can remove a book (or books) from the Library from the Library screen/settings; removal is manual only.
3. Re-opening a book that was removed from Library adds it to Library again (auto-add behavior is consistent).
4. Library list and any "recent" or "in progress" behavior remain consistent with existing app behavior where applicable.

## Tasks / Subtasks

- [ ] Task 1: Implement `library_entries` table in app metadata DB (AC: 1, 2, 3)
  - [ ] Add `library_entries` table schema to `src/database/appMetaRepository.ts`: columns `book_id` (TEXT, PRIMARY KEY), `added_at` (TEXT, ISO-8601), `last_opened_at` (TEXT, ISO-8601). [Source: architecture/data-models-and-schema.md#library_entries]
  - [ ] Implement methods: `addToLibrary(bookId)` — insert new row or update `last_opened_at` if already exists; `removeFromLibrary(bookId)` — delete row; `getLibraryEntries()` — return all entries ordered by `last_opened_at` desc; `isInLibrary(bookId)` — check existence. [Source: architecture/data-models-and-schema.md#library_entries]

- [ ] Task 2: Create library Redux slice (AC: 1, 2, 3, 4)
  - [ ] Create `src/state/slices/librarySlice.ts` — state: `libraryBookIds[]` (ordered by last opened), `loading`, `error`. [Source: architecture/source-tree.md#GrqaserApp, architecture/grqaserapp-data-integration-and-audio.md#Library-behavior]
  - [ ] Async thunks: `addBookToLibrary(bookId)` — calls `appMetaRepository.addToLibrary()`, updates state. `removeBookFromLibrary(bookId)` — calls `appMetaRepository.removeFromLibrary()`, updates state. `fetchLibraryEntries()` — loads all entries on app init or Library screen focus. [Source: architecture/grqaserapp-data-integration-and-audio.md#Library-behavior]
  - [ ] Register slice in store configuration. [Source: architecture/source-tree.md#GrqaserApp]

- [ ] Task 3: Trigger auto-add on book open (AC: 1, 3)
  - [ ] In `BookDetailScreen.tsx`: on screen mount (or `useEffect` on book ID change), dispatch `addBookToLibrary(bookId)`. This handles both new additions and re-opens of previously removed books. [Source: architecture/grqaserapp-data-integration-and-audio.md#Library-behavior]
  - [ ] In playback service or player screen: if playback starts for a book that is not yet in Library (edge case: direct play without visiting detail), also dispatch `addBookToLibrary(bookId)`. [Source: architecture/grqaserapp-data-integration-and-audio.md#Library-behavior]
  - [ ] `addToLibrary` in the repository handles upsert (insert or update `last_opened_at`), so duplicate dispatches are safe. [Source: architecture/data-models-and-schema.md#library_entries]

- [ ] Task 4: Update Library screen with auto-added books and manual remove (AC: 1, 2, 4)
  - [ ] Update `LibraryScreen.tsx` to display books from `librarySlice` state. Fetch library entries on screen focus. For each library entry, load book metadata from `catalogRepository.getBookById(bookId)` (local DB). [Source: architecture/grqaserapp-data-integration-and-audio.md#Library-behavior]
  - [ ] Library list layout per design mockup: horizontal card with cover image (80x110px), title, author, duration + progress percentage. Each item has a remove button (circular "x" on the right). [Source: docs/design/grqaser-app/library.html]
  - [ ] Filter pills at top: "In progress", "Favorites", "Downloaded" — these filter the library list by respective criteria. "In progress" shows books with playback progress; "Favorites" filters by favorited books; "Downloaded" filters by books with downloaded MP3s (from `downloadSlice`). [Source: docs/design/grqaser-app/library.html]
  - [ ] Remove button dispatches `removeBookFromLibrary(bookId)`. After removal, the book disappears from the list immediately. [Source: architecture/grqaserapp-data-integration-and-audio.md#Library-behavior]

- [ ] Task 5: Write tests (AC: 1–4)
  - [ ] Unit tests for `appMetaRepository.ts` `library_entries` methods: add, remove, get all, is in library, upsert behavior. [Source: architecture/testing-and-deployment-strategy.md#GrqaserApp]
  - [ ] Unit tests for `librarySlice.ts`: test reducers, async thunks (add, remove, fetch). [Source: architecture/testing-and-deployment-strategy.md#GrqaserApp]
  - [ ] Integration test: open book detail → verify auto-add to library → remove from library → re-open → verify re-added. [Source: architecture/testing-and-deployment-strategy.md#GrqaserApp]
  - [ ] Test: library list shows correct books with metadata from local DB. [Source: architecture/testing-and-deployment-strategy.md#GrqaserApp]
  - [ ] Run all existing tests and lint; no regressions. [Source: architecture/testing-and-deployment-strategy.md#GrqaserApp]

## Dev Notes

### Dependencies on Previous Stories

- Story 8.1 must be completed: provides `database/appMetaRepository.ts`, `database/catalogRepository.ts`, local SQLite infrastructure, TypeScript types (`LibraryEntry`).
- Story 8.2 is recommended before this story for the "Downloaded" filter pill in Library (uses `downloadSlice` state), but the Library screen can be built with a stub/disabled filter if 8.2 is not done yet.

### Architecture — Library Behavior

- **Auto-add:** When the user opens a book (book detail or starts playback), that book is automatically added to Library. No separate "Add to Library" action required. [Source: architecture/grqaserapp-data-integration-and-audio.md#Library-behavior]
- **Manual remove:** User can remove books from Library manually. Deletion removes the `library_entries` row. [Source: architecture/grqaserapp-data-integration-and-audio.md#Library-behavior]
- **Re-open behavior:** Re-opening a previously removed book adds it back (auto-add is consistent). [Source: architecture/grqaserapp-data-integration-and-audio.md#Library-behavior]
- **Tracking:** Library entries stored locally in `library_entries` table in `grqaser_app_meta.db`. [Source: architecture/grqaserapp-data-integration-and-audio.md#Library-behavior]

### Data Model — `library_entries` Table

| Column | Type | Notes |
|--------|------|-------|
| book_id | TEXT | PRIMARY KEY; references book ID in active catalog DB |
| added_at | TEXT | NOT NULL; ISO-8601 timestamp of first open |
| last_opened_at | TEXT | NOT NULL; ISO-8601 timestamp of most recent open |

Lives in the app metadata SQLite database (`grqaser_app_meta.db`).

[Source: architecture/data-models-and-schema.md#library_entries]

### Design Mockup Reference — Library Screen

Per `docs/design/grqaser-app/library.html`:

- **Header:** "Library" with subtitle "Your reading & listening".
- **Filter pills:** "In progress" (active by default), "Favorites", "Downloaded" — horizontal scrollable pill buttons.
- **Library list:** Horizontal card layout per item: cover image (80x110px, rounded corners) on left, book info (title, author, duration + progress %) on right, remove button (circular "x") on far right.
- **Downloaded badge:** Teal circle with down-arrow on cover for books that have downloaded MP3s.
- **Remove button:** Gray circle with "x", turns red on hover/press.

### Source Tree — New/Modified Files

```
GrqaserApp/src/
├── state/slices/
│   └── librarySlice.ts           # NEW — Library auto-add/remove state
├── database/
│   └── appMetaRepository.ts      # MODIFIED — Add library_entries table CRUD
├── screens/
│   ├── BookDetailScreen.tsx      # MODIFIED — Dispatch auto-add on open
│   └── LibraryScreen.tsx         # MODIFIED — Show library entries, remove button, filter pills
```

[Source: architecture/source-tree.md#GrqaserApp]

### Technical Constraints

- React Native, TypeScript, Redux Toolkit. [Source: architecture/tech-stack.md#GrqaserApp]
- Library entries are local-only; never synced to server. [Source: architecture/grqaserapp-data-integration-and-audio.md#Library-behavior]
- `addToLibrary` must be an upsert to handle re-opens gracefully. [Source: architecture/data-models-and-schema.md#library_entries]

### Testing

- **Test location:** `GrqaserApp/__tests__/` or co-located `*.test.ts` files.
- **Frameworks:** Jest, React Native Testing Library. [Source: architecture/tech-stack.md#GrqaserApp]
- **Key flows:** Auto-add on book open, manual remove, re-add on re-open. [Source: architecture/testing-and-deployment-strategy.md#GrqaserApp]
- **Lint:** `npm run lint`. Tests: `npm test`. [Source: architecture/testing-and-deployment-strategy.md#GrqaserApp]

## Change Log

| Date       | Version | Description                    | Author       |
|-----------|---------|--------------------------------|--------------|
| 2026-02-20 | 1.0     | Story created from Epic 8      | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_None yet_

### Completion Notes List

_None yet_

### File List

_None yet_

## QA Results

_None yet_
