# Story 5.2: GrqaserApp testing and build

## Status

Done

## Story

**As a** developer,  
**I want** component/unit and integration tests for GrqaserApp and working iOS/Android builds,  
**so that** we can ship to TestFlight/Internal testing.

## Acceptance Criteria

1. Key components and flows have unit/integration tests; critical path (e.g., play a book) has E2E where feasible.
2. iOS and Android build and run from the repo; signing and env config are documented.
3. Lint and test run in CI where applicable.

## Tasks / Subtasks

- [x] Task 1: GrqaserApp test coverage (AC: 1)
  - [x] Key components and flows have unit/integration tests ([Source: docs/architecture/testing-and-deployment-strategy.md]).
  - [x] Critical path (e.g. play a book) has E2E where feasible ([Source: docs/architecture/tech-stack.md] — Jest, React Native Testing Library).
  - [x] Run: `npm test`, `npm run lint` from `GrqaserApp/` ([Source: docs/architecture/testing-and-deployment-strategy.md]).
- [x] Task 2: iOS and Android builds (AC: 2)
  - [x] iOS and Android build and run from repo ([Source: docs/architecture/testing-and-deployment-strategy.md]).
  - [x] Document signing and env config for TestFlight/internal distribution ([Source: docs/architecture/testing-and-deployment-strategy.md]).
- [x] Task 3: CI (AC: 3)
  - [x] Lint and test run in CI where applicable ([Source: docs/architecture/testing-and-deployment-strategy.md]).
  - [x] Add or document CI job for GrqaserApp.

## Dev Notes

### Previous Story Insights

Story 5.1 covers crawler and database-viewer tests. This story focuses on GrqaserApp tests and builds so the app can be shipped to TestFlight/internal testing.

### File Locations

- **GrqaserApp:** `GrqaserApp/` (tests, `android/`, `ios/`) ([Source: docs/architecture/source-tree.md]). **CI:** Root or GrqaserApp-specific config ([Source: docs/architecture/testing-and-deployment-strategy.md]).

### Technical Constraints

- Jest, React Native Testing Library; E2E for critical flows; ESLint, Prettier ([Source: docs/architecture/tech-stack.md]).

### Testing

- Validate by running lint and test from `GrqaserApp/` and producing iOS/Android builds.

## Change Log

| Date       | Version | Description                    | Author       |
|-----------|---------|--------------------------------|--------------|
| 2025-02-14 | 1.0     | Story created from Epic 5     | Scrum Master |
| 2025-02-21 | 1.1     | Story 5.2 implemented: tests, build/signing docs, CI | Dev Agent |

## Dev Agent Record

### Agent Model Used

—

### Debug Log References

- `npm test` from `GrqaserApp/` — playerSlice and BookCard tests pass (16 tests). Full suite: 12 passed, 2 failed (App.test.tsx and another hit native TurboModule in Jest). `npm run lint` reports pre-existing prettier/curly issues in other files; new test file formatted to satisfy prettier.

### Completion Notes List

- Added playerSlice unit tests (play/pause, current book, queue, progress, resetPlayer) for critical path. Added BookCard component tests (render, compact, onPress, cover image). Existing tests cover slices, services, database, screens; E2E (e.g. Detox) left as future where feasible.
- Documented iOS/Android build commands and signing/env for TestFlight/internal in docs/architecture/grqaserapp-build-and-signing.md; linked from testing-and-deployment-strategy.md.
- Added .github/workflows/grqaserapp-lint-test.yml to run lint and test on GrqaserApp/** changes. Consolidated Jest config in package.json (removed duplicate jest.config.js).

### File List

- GrqaserApp/__tests__/state/slices/playerSlice.test.ts (new)
- GrqaserApp/__tests__/components/BookCard.test.tsx (new)
- docs/architecture/grqaserapp-build-and-signing.md (new)
- docs/architecture/testing-and-deployment-strategy.md (modified)
- .github/workflows/grqaserapp-lint-test.yml (new)
- GrqaserApp/jest.config.js (removed — config kept in package.json)

## QA Results

### Review Date: 2026-02-21

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Story deliverables are in place: **playerSlice.test.ts** covers play/pause, current book, queue, progress, duration, playback rate, shuffle, repeat, error handling, and resetPlayer (critical path). **BookCard.test.tsx** covers render, compact mode, onPress, and cover image. **grqaserapp-build-and-signing.md** documents iOS/Android build commands, signing (Xcode / build.gradle), and TestFlight/internal distribution. **.github/workflows/grqaserapp-lint-test.yml** runs lint and test on GrqaserApp changes. Jest config consolidated in package.json. E2E (e.g. Detox) left as future per story scope.

### Refactoring Performed

None. No code changes made during review.

### Compliance Check

- Coding Standards: ✓ New test files follow TypeScript and project patterns; build doc aligns with testing-and-deployment-strategy.
- Project Structure: ✓ Tests under `GrqaserApp/__tests__/`; build doc in `docs/architecture/`.
- Testing Strategy: ✓ Unit/integration for key components and player slice; E2E deferred where feasible as noted in story.
- All ACs Met: ✓ AC1 (key components/flows tested; E2E where feasible deferred), AC2 (builds + signing/env doc), AC3 (CI job added). CI and local run currently fail for reasons below.

### Improvements Checklist

- [ ] Fix pre-existing GrqaserApp lint errors (27) so `npm run lint` and CI pass (MNT-001).
- [ ] Address App.test.tsx (and native-dependent suite) so Jest passes in CI—e.g. mock gesture handler or exclude (TEST-001).

### Security Review

No concerns. Build/signing doc correctly advises not committing keystore passwords; use env or gitignored keystore.properties.

### Performance Considerations

None for this story.

### Files Modified During Review

None.

### Gate Status

Gate: CONCERNS → docs/qa/gates/5.2-grqaserapp-testing-and-build.yml

### Recommended Status

✗ Changes Required — Story implementation is complete, but CI will remain red until pre-existing lint is fixed and native-dependent tests are mocked or excluded. Recommend dev address MNT-001 and TEST-001 (or team waives with CONCERNS and tracks in backlog) then set Ready for Done.

---

### Review Date: 2026-02-21 (re-review)

### Reviewed By: Quinn (Test Architect)

### Re-review Summary

Dev addressed **TEST-001**: native-dependent tests now pass. Verified locally: **14 test suites passed, 149 tests passed** (including App.test.tsx and all slices/components). **MNT-001** remains: `npm run lint` still reports 31 problems (24 errors, 7 warnings) in GrqaserApp; CI runs lint first so the job will still fail on the lint step.

### Compliance Check (re-review)

- Tests: ✓ All 14 suites pass; story test deliverables and existing suite green.
- Lint: ✗ Still failing; pre-existing issues in files outside story scope (mocks, services, src components).

### Gate Status (updated)

Gate: CONCERNS → docs/qa/gates/5.2-grqaserapp-testing-and-build.yml (TEST-001 removed; MNT-001 retained)

### Recommended Status (re-review)

✗ Changes Required — Fix remaining lint (MNT-001) so CI is green, then Ready for Done. Alternatively, team may waive CONCERNS and mark Done with lint tracked in backlog.
