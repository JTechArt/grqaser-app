# Story 2.1: Books API and stats API

## Status

Done

## Story

**As an** operator,  
**I want** a REST API for books (list, by id, search) and stats (overview, authors, categories),  
**so that** I can integrate and debug catalog data programmatically.

## Acceptance Criteria

1. `GET /api/v1/books` returns a list with pagination/filters as needed.
2. `GET /api/v1/books/:id` returns a single book by id.
3. `GET /api/v1/books/search?q=...` returns search results.
4. Stats endpoints (e.g., overview, authors, categories) return counts/aggregates consistent with the schema.

## Tasks / Subtasks

- [x] Task 1: Books list endpoint (AC: 1)
  - [x] Implement `GET /api/v1/books` with pagination and filters (e.g. page, limit, category, author) ([Source: docs/architecture/database-viewer-api-and-deployment.md]).
  - [x] Read from SQLite via database layer; return JSON consistent with data contract ([Source: docs/architecture/data-models-and-schema.md]).
  - [x] Unit test route; integration test with DB.
- [x] Task 2: Book by id and search (AC: 2, 3)
  - [x] Implement `GET /api/v1/books/:id` returning a single book or 404 ([Source: docs/architecture/database-viewer-api-and-deployment.md]).
  - [x] Implement `GET /api/v1/books/search?q=...` returning search results (title/author/description match).
  - [x] Unit/integration tests for both.
- [x] Task 3: Stats endpoints (AC: 4)
  - [x] Implement stats endpoints (overview, authors, categories) with counts/aggregates consistent with schema ([Source: docs/architecture/database-viewer-api-and-deployment.md], [Source: docs/architecture/data-models-and-schema.md]).
  - [x] Unit/integration tests for stats responses.

## Dev Notes

### Previous Story Insights

Epic 2 starts only after Epic 1 (crawler) is complete. Assume crawler has produced full catalog with documented schema; database-viewer is read-only.

### Data Models

- **Books** and any category/author tables from crawler schema. API responses align with [Source: docs/architecture/data-models-and-schema.md]. Stats: overview (e.g. total books), authors (counts), categories (counts/aggregates).

### API Specifications

- **Base:** `/api/v1`. **Books:** `GET /api/v1/books`, `GET /api/v1/books/:id`, `GET /api/v1/books/search?q=...`. **Stats:** Overview, authors, categories ([Source: docs/architecture/database-viewer-api-and-deployment.md]).

### File Locations

- **Entry:** `database-viewer/src/server.js`. **Config:** `database-viewer/src/config/config.js`. **Routes:** e.g. `database-viewer/src/routes/books.js`, `stats.js`. **Models:** `database-viewer/src/models/database.js` (SQLite read-only). **API:** under `/api/v1` ([Source: docs/architecture/database-viewer-api-and-deployment.md], [Source: docs/architecture/source-tree.md]).

### Technical Constraints

- Express 4.x; read-only DB access; REST; consistent error formats and HTTP status codes ([Source: docs/architecture/tech-stack.md], [Source: docs/architecture/coding-standards.md]). Config: port, DB path, CORS externalized.

### Testing

- Unit tests for API handlers; integration tests for API + DB ([Source: docs/architecture/testing-and-deployment-strategy.md]). Run: `npm test` from `database-viewer/`.

## Change Log

| Date       | Version | Description                    | Author       |
|-----------|---------|--------------------------------|--------------|
| 2025-02-14 | 1.0     | Story created from Epic 2     | Scrum Master |
| 2026-02-16 | 1.1     | Story 2.1 implemented; books/stats tests added | Dev Agent |
| 2026-02-16 | 1.2     | QA fixes: SEC-001 sort whitelist; sort tests added | Dev Agent |

## Dev Agent Record

### Agent Model Used

Auto (develop-story 2.1)

### Debug Log References

- `npm test` from database-viewer: 26 tests passed (books, stats, crawler, health).

### Completion Notes List

- Books list, by-id, and search endpoints and stats (overview, authors, categories) were already implemented in database-viewer routes and Database model. Verified against AC1–AC4 and architecture docs.
- Extended test DB schema (description, updated_at) and added seedBooks() for API tests. Added tests/books.test.js (GET /books, /books/:id, /books/search) and tests/stats.test.js (GET /stats/overview, /stats/authors, /stats/categories). All tests pass.
- QA fixes (2.1 gate CONCERNS): (1) SEC-001 — Whitelisted sort_by and sort_order in database.js getBooks() (ALLOWED_SORT_COLUMNS + ASC/DESC only) to prevent SQL injection. (2) TEST-001 — books.test.js and stats.test.js already present; added two tests in books.test.js for sort whitelist (invalid ignored, valid sort_by/sort_order). All 30 tests pass.

### File List

- database-viewer/tests/create-test-db.js (modified: books schema + seedBooks)
- database-viewer/tests/books.test.js (new; + sort whitelist tests)
- database-viewer/tests/stats.test.js (new)
- database-viewer/src/models/database.js (modified: sort whitelist SEC-001)

## QA Results

### Review Date: 2025-02-16

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Books and stats APIs are implemented as specified: `GET /api/v1/books` (list with pagination/filters), `GET /api/v1/books/:id`, `GET /api/v1/books/search?q=...`, and stats at `/api/v1/stats/overview`, `/authors`, `/categories`. Response shape is consistent (success/data, error code/message). Config (port, DB path, CORS, rate limit) is externalized. Two issues block a full pass: unvalidated sort params (SQL injection risk) and missing dedicated tests for books and stats.

### Refactoring Performed

None. Findings are advisory; fixes are for the dev agent or team to implement.

### Compliance Check

- Coding Standards: ✓ (REST under /api/v1, config externalized, error format consistent)
- Project Structure: ✓ (server.js, config, routes/books.js, routes/stats.js, models/database.js)
- Testing Strategy: ✗ (no books or stats test file; story tasks require unit/integration tests for these routes)
- All ACs Met: ✓ (implementation satisfies AC1–AC4; test coverage for ACs is missing)

### Improvements Checklist

- [ ] Whitelist sort_by and sort_order in getBooks() to prevent SQL injection (database.js, books route)
- [ ] Add books API tests: list (pagination/filters), by id, search (database-viewer/tests/)
- [ ] Add stats API tests: overview, authors, categories (database-viewer/tests/)
- [x] N/A — Consider validating page/limit as integers in books route (future)

### Security Review

**CONCERNS:** `sort_by` and `sort_order` from query string are passed into `ORDER BY` in `database.js` getBooks() without whitelisting. An attacker can influence the SQL (e.g. sort_by=id; DROP TABLE books--). Rate limiting and CORS are in place.

### Performance Considerations

Pagination and limit caps (e.g. max 100) are applied; read-only access is appropriate. No issues noted.

### Files Modified During Review

None.

### Gate Status

Gate: CONCERNS → docs/qa/gates/2.1-books-api-and-stats-api.yml

### Recommended Status

**✗ Changes Required** — Address SEC-001 (sort whitelist) and add tests for books and stats per story tasks; then re-run review.

---

### Review Date: 2025-02-16 (re-review)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Dev addressed both prior issues. **SEC-001:** `database.js` getBooks() now uses `ALLOWED_SORT_COLUMNS` and validates sort column and direction (safeSortBy / safeSortOrder); invalid values fall back to defaults. **TEST-001:** `tests/books.test.js` and `tests/stats.test.js` cover GET /books (list, pagination, filters, sort whitelist), GET /books/:id, GET /books/search, and GET /stats/overview, /authors, /categories. Explicit test for malicious sort_by confirms whitelist behavior. All 31 tests pass.

### Refactoring Performed

None.

### Compliance Check

- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓ (books and stats tests in place)
- All ACs Met: ✓

### Improvements Checklist

- [x] Whitelist sort_by and sort_order in getBooks() (SEC-001)
- [x] Add books API tests (list, by id, search, sort whitelist)
- [x] Add stats API tests (overview, authors, categories)

### Security Review

**PASS.** Sort params are whitelisted; injection attempt covered by test.

### Gate Status

Gate: PASS → docs/qa/gates/2.1-books-api-and-stats-api.yml

### Recommended Status

**✓ Ready for Done**
