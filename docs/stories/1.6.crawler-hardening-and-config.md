# Story 1.6: Crawler hardening & config sanity

## Status

Draft

## Story

**As a** crawler maintainer,
**I want** the crawler to load environment-specific config reliably, back off on retries, and enforce stronger validation/dedup with clear observability,
**so that** runs are stable, data quality improves, and operators can tune behavior safely across environments.

## Context

Recent ad-hoc improvements were reverted; this story formalizes them as a planned increment. Goals: merge env overrides from `crawler-config.js`, add retry backoff, harden validation (audio URL, duration, rating bounds, language length), improve dedup (by id + title|author), and add basic observability for retry/queue stats. Linting currently fails due to missing ESLint config; include a plan for a project-aligned config.

## Acceptance Criteria

1. **Config merge**: Base config is merged with `environments[NODE_ENV]`; crawler launch uses merged browser/logging/crawling settings.
2. **Retry discipline**: URL retries increment once per attempt and use exponential backoff with jitter before retrying; delayBetweenPages uses a shared sleep helper.
3. **Data validation**: Book validation enforces non-empty main_audio_url, duration ≥ 0, rating 0–5, rating_count non-negative integer, language length ≤ 10, and non-empty title; invalid rows are skipped with reasons logged.
4. **Dedup**: Crawler skips duplicates by both (title|author) and book id; counters reflect duplicates skipped.
5. **Observability**: Logs include retry attempt count/backoff, and queue summary still reports processed/completed/failed with books_found/saved averages.
6. **Lint readiness**: An ESLint config is introduced or documented so `npm run lint` no longer fails due to missing config (rules may be minimal but executable).

## Tasks / Subtasks

- [ ] Task 1: Config merge and wiring (AC: 1)
  - [ ] Implement deep merge of base config with env overrides; store merged config on crawler instance.
  - [ ] Apply merged browser/logging/crawling settings in initialization and launch.
- [ ] Task 2: Retry/backoff mechanics (AC: 2, 5)
  - [ ] Add helper for sleep/backoff with jitter; use for retry and inter-page delay.
  - [ ] Ensure retry_count increments only once per retry transition; log attempt and backoff used.
- [ ] Task 3: Validation hardening (AC: 3)
  - [ ] Extend `book-validator` with stricter rules (audio URL non-empty, duration ≥0, rating bounds, rating_count integer ≥0, language length ≤10, non-empty title) and log reasons on skip.
  - [ ] Add/extend tests covering new validation paths.
- [ ] Task 4: Dedup robustness (AC: 4)
  - [ ] Track seen book IDs in addition to title|author; skip duplicates and count them.
  - [ ] Add tests (unit/integration) to confirm duplicates are skipped by id and title|author.
- [ ] Task 5: Observability (AC: 5)
  - [ ] Include retry attempt/backoff ms in error/info logs for URL retries.
  - [ ] Keep/extend queue summary to show processed/completed/failed with averages; ensure it still runs after changes.
- [ ] Task 6: Lint setup (AC: 6)
  - [ ] Add an ESLint config aligned with project conventions (or minimal executable config) so `npm run lint` passes.
  - [ ] Wire Jest/Node settings as needed; update package scripts only if required for lint to run.

## Dev Notes

- Follow existing coding standards (`docs/architecture/coding-standards.md`) and avoid altering schema unless required.
- Keep crawler entrypoint as `crawler/src/crawler.js`; utilities: `url-validator`, `book-validator`, `text-cleaner`, `duration-parser`.
- Logging: continue using `crawl_logs` table and optional file log paths from config.

## Testing

- Unit: validation changes, retry helper, config merge, dedup logic.
- Integration: a short crawl run using a small queue to confirm retries/backoff, dedup, and logging; `npm test` covers new cases.
- Lint: `npm run lint` should execute without missing-config errors.

## Change Log

| Date       | Version | Description            | Author |
|------------|---------|------------------------|--------|
| 2025-02-15 | 1.0     | Story created (draft)  | —      |
