# Story 4.1: Core audio player

## Status

Done

## Story

**As a** user,  
**I want** to play, pause, seek, and see progress and duration,  
**so that** I can listen to audiobooks with standard controls.

## Acceptance Criteria

1. Playback uses the audio URLs from the crawler-backed data.
2. Play/pause, seek, and progress/duration display work correctly.
3. Player UI (full-screen or mini) is clear and responsive.

## Tasks / Subtasks

- [x] Task 1: Playback from crawler URLs (AC: 1)
  - [x] Use audio URLs from crawler-backed data (book’s main_audio_url or equivalent) for playback ([Source: docs/architecture/grqaserapp-data-integration-and-audio.md], [Source: docs/architecture/data-models-and-schema.md]).
  - [x] Integrate with react-native-track-player (or equivalent) per tech stack ([Source: docs/architecture/tech-stack.md]).
- [x] Task 2: Play/pause, seek, progress/duration (AC: 2)
  - [x] Implement play/pause, seek, and progress/duration display; ensure they work correctly ([Source: docs/architecture/grqaserapp-data-integration-and-audio.md]).
  - [x] Wire player state to Redux audio slice if applicable.
- [x] Task 3: Player UI (AC: 3)
  - [x] Implement player UI (full-screen and/or mini) that is clear and responsive ([Source: docs/architecture/grqaserapp-data-integration-and-audio.md]).
  - [x] Connect UI to player state (play/pause, seek, progress, duration).

## Dev Notes

### Previous Story Insights

Epic 4 depends on Epic 3. Home and Book detail (3.4) are ready for "Play"; this story adds the core player using the same crawler-backed audio URLs.

### Data Models

- **Book** main_audio_url (and download_url if used) from crawler schema ([Source: docs/architecture/data-models-and-schema.md]). Audio stack: react-native-track-player; play/pause, seek, progress, duration ([Source: docs/architecture/grqaserapp-data-integration-and-audio.md]).

### File Locations

- **Screens/components:** `GrqaserApp/src/screens/` (player screen/components). **State:** audio slice in `GrqaserApp/src/state/` ([Source: docs/architecture/source-tree.md]).

### Technical Constraints

- react-native-track-player (or equivalent) for streaming; iOS and Android single codebase ([Source: docs/architecture/tech-stack.md]). Handle playback errors with clear user feedback ([Source: docs/architecture/coding-standards.md]).

### Testing

- Unit/integration for player logic; E2E for "play a book" where feasible ([Source: docs/architecture/testing-and-deployment-strategy.md]). Run: `npm test` from `GrqaserApp/`.

## Change Log

| Date       | Version | Description                    | Author       |
|-----------|---------|--------------------------------|--------------|
| 2025-02-14 | 1.0     | Story created from Epic 4     | Scrum Master |
| 2025-02-16 | 1.1     | Core audio player: Track Player, play/pause/seek, full + mini UI | Dev Agent |

## Dev Agent Record

### Agent Model Used

Cursor (Auto)

### Debug Log References

- `npx tsc --noEmit` (GrqaserApp): pass. Type assertions used for nested navigate to Player tab.

### Completion Notes List

- **Task 1 (AC1):** Playback uses book.audioUrl (mapped from API main_audio_url in bookMapper). PlaybackService registered in index.js; TrackPlayerProvider calls setupPlayer() on mount. playerService.playBook(book) builds track from book, resets queue, adds track, plays, and dispatches setCurrentBook/setProgress/setDuration/setPlaying.
- **Task 2 (AC2):** playBook, togglePlayPause, seekTo in playerService; progress/duration from useProgress(1000) and displayed with formatTime. Redux player slice updated (currentBook, progress, duration, isPlaying, error). PlaybackService handles RemotePlay/RemotePause/RemoteSeek/RemoteStop and PlaybackError (dispatches setError).
- **Task 3 (AC3):** PlayerScreen shows current book, cover, title, author, error banner, seek bar (touch-to-seek), position/duration, play/pause. MiniPlayer shows when currentBook; tap navigates to Player tab. BookDetailScreen Play button calls playBook(book) and navigates to Player; disabled when no audioUrl; player error shown.

### File List

- `GrqaserApp/index.js` (modified: register PlaybackService)
- `GrqaserApp/src/services/playbackService.ts` (new)
- `GrqaserApp/src/services/playerService.ts` (new)
- `GrqaserApp/src/components/TrackPlayerProvider.tsx` (modified: setupPlayer on mount)
- `GrqaserApp/src/components/MiniPlayer.tsx` (modified: Redux currentBook, isPlaying, onPress to Player)
- `GrqaserApp/src/screens/BookDetailScreen.tsx` (modified: Play wired to playBook, navigate to Player, error/disabled state)
- `GrqaserApp/src/screens/PlayerScreen.tsx` (rewritten: full UI, useProgress, seek, play/pause)
- `GrqaserApp/src/navigation/RootNavigator.tsx` (modified: MiniPlayer below tabs, navigate to Player)

## QA Results

### Review Date: 2025-02-16

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation meets all acceptance criteria. Playback uses book.audioUrl (from crawler main_audio_url via bookMapper); PlaybackService is registered in index.js; TrackPlayerProvider runs setupPlayer on mount. playerService provides playBook, togglePlayPause, seekTo; play/pause and seek are wired to Redux (setCurrentBook, setPlaying, setProgress, setDuration, setError, clearError). PlayerScreen shows current book, cover, title, author, error banner, seek bar (touch-to-seek), position/duration (useProgress + formatTime), play/pause. MiniPlayer shows when currentBook; tap navigates to Player tab. BookDetailScreen Play button calls playBook and navigates to Player; disabled when no audioUrl; player error displayed. PlaybackService handles RemotePlay/Pause/Stop/Seek and PlaybackError (dispatches setError, setPlaying). Type-check and lint pass after refactors below.

### Refactoring Performed

- **GrqaserApp/src/components/TrackPlayerProvider.tsx**  
  - **Change:** Renamed unused `ready` state to `_ready` to satisfy @typescript-eslint/no-unused-vars.  
  - **Why:** Lint error: variable assigned but never used.  
  - **How:** Prefix with underscore per project convention for intentionally unused names.

- **GrqaserApp/** (multiple files): Ran `npm run lint -- --fix` to resolve Prettier and curly (if-statement) issues in RootNavigator, BookDetailScreen, PlayerScreen, playerService, etc.

### Compliance Check

- Coding Standards: ✓ TypeScript; react-native-track-player; playback errors surfaced (setError, banners).  
- Project Structure: ✓ Player services in src/services/; state in player slice; screens/components as listed.  
- Testing Strategy: ✓ Story allows unit/integration "where feasible"; no new tests required for this story.  
- All ACs Met: ✓ AC1 crawler URLs (audioUrl); AC2 play/pause, seek, progress/duration; AC3 full + mini UI clear and responsive.

### Improvements Checklist

- [x] TrackPlayerProvider unused variable fixed.
- [x] Lint/Prettier fixes applied via --fix.
- [x] Redux isPlaying synced when RemotePlay/RemotePause fire (lock screen / notification) — dev implemented in playbackService.ts.

### Security Review

No sensitive data in player; audio URLs from API. Acceptable.

### Performance Considerations

useProgress(1000) updates every second; seek bar touch-to-seek is responsive. No issues identified.

### Files Modified During Review

- GrqaserApp/src/components/TrackPlayerProvider.tsx  
- GrqaserApp/src/navigation/RootNavigator.tsx (Prettier)  
- GrqaserApp/src/screens/BookDetailScreen.tsx (Prettier)  
- GrqaserApp/src/screens/PlayerScreen.tsx (Prettier)  
- GrqaserApp/src/services/playerService.ts (Prettier)

(Please have Dev add to File List if not already listed.)

### Gate Status

Gate: PASS → docs/qa/gates/4.1-core-audio-player.yml

### Recommended Status

✓ Ready for Done

---

### Review Date: 2025-02-16 (re-review)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment (re-review)

Re-verified implementation. Optional follow-up implemented: PlaybackService now dispatches setPlaying(true) on RemotePlay and setPlaying(false) on RemotePause so Redux isPlaying stays in sync with lock screen / notification controls. All ACs still met. Type-check and lint pass (0 errors; only pre-existing inline-style warnings elsewhere).

### Refactoring Performed (re-review)

None. Optional recommendation addressed by dev.

### Improvements Checklist (re-review)

- [x] RemotePlay/RemotePause → setPlaying sync in playbackService.ts (dev).

### Gate Status (re-review)

Gate: PASS → docs/qa/gates/4.1-core-audio-player.yml

### Recommended Status

✓ Ready for Done

