# Story 8.5: Settings — storage usage and mobile data usage

## Status

Draft

## Story

**As a** mobile user,
**I want** the Settings page to show mobile data usage and storage usage (allocated vs used with percentage),
**so that** I can see how much data and storage the app is using.

## Acceptance Criteria

1. **Mobile data usage:** Settings displays the app's mobile data usage (e.g., total or period-based as per platform capabilities).
2. **Storage usage:** Settings displays storage used by the app: allocated (or total available for the app) and used, with a percentage (e.g., "X MB used of Y MB allocated (Z%)" or equivalent).
3. Display is clear and stays accurate after downloads, cleanup, or DB changes (Stories 8.2, 8.3).
4. No regression in existing Settings options (theme, cleanup, DB management, etc.).

## Tasks / Subtasks

- [ ] Task 1: Implement storage usage calculation (AC: 2, 3)
  - [ ] Create a `getStorageUsage()` function (in `downloadManager.ts` or a new `src/services/storageService.ts`): compute total storage used by the app from `downloaded_mp3s` (sum of `file_size_bytes` from `appMetaRepository`) + `managed_databases` (sum of `file_size_bytes` from `appMetaRepository`) + other app data (platform API or estimate). [Source: architecture/data-models-and-schema.md#Notes-on-mobile-schema-management]
  - [ ] Compute allocated/available storage using platform APIs (`react-native-fs` `getFSInfo()` or equivalent) to get total device/app storage capacity. [Source: architecture/tech-stack.md#GrqaserApp]
  - [ ] Return a `StorageUsage` object: `{ allocatedBytes, usedBytes, percentage, breakdown: { mp3Bytes, databaseBytes, otherBytes } }`. [Source: architecture/data-models-and-schema.md#TypeScript-client-types]
  - [ ] Ensure storage metrics update correctly after downloads (8.2), cleanup (8.2), and DB changes (8.3). Re-query on screen focus or after relevant actions. [Source: architecture/grqaserapp-data-integration-and-audio.md#UX-and-navigation]

- [ ] Task 2: Implement mobile data usage tracking (AC: 1, 3)
  - [ ] Investigate platform capabilities for mobile data usage tracking: iOS (`NetworkExtension` or `SystemConfiguration`) and Android (native module or platform API). If platform APIs provide app-level data usage, use them. If not available natively, track manually by accumulating bytes from streaming + download + DB update operations. [Source: architecture/grqaserapp-data-integration-and-audio.md#UX-and-navigation]
  - [ ] Create a `getMobileDataUsage()` function (in `storageService.ts` or similar): return total and per-category data usage (streaming, downloads, DB updates) for the current period (e.g., "This Month"). [Source: architecture/data-models-and-schema.md#Notes-on-mobile-schema-management]
  - [ ] If manual tracking is needed: instrument `downloadManager` (MP3 download bytes), `databaseManager` (DB download bytes), and audio streaming (track bytes streamed) to accumulate data usage. Store accumulated values in `AsyncStorage` or app metadata DB, resettable monthly. [Source: architecture/tech-stack.md#GrqaserApp]

- [ ] Task 3: Build storage usage UI in Settings (AC: 2, 3)
  - [ ] In `SettingsScreen.tsx` (or `ProfileScreen.tsx`), add a "Storage Usage" section per the design mockup. [Source: docs/design/grqaser-app/profile.html]
  - [ ] Display: "App Storage" label, "X MB / Y GB" value (accent color), progress bar (teal gradient fill), "Z% used" text. [Source: docs/design/grqaser-app/profile.html]
  - [ ] Breakdown list below the progress bar: "Downloaded MP3s" (accent dot), "Databases" (indigo dot), "Other" (muted dot) — each with size value. [Source: docs/design/grqaser-app/profile.html]
  - [ ] Style per mockup: usage card with border, rounded corners, shadow; header row with label and value; progress bar track (8px, muted bg) with gradient fill; percentage text; breakdown items with colored dots. [Source: docs/design/grqaser-app/profile.html]

- [ ] Task 4: Build mobile data usage UI in Settings (AC: 1, 3)
  - [ ] In `SettingsScreen.tsx`, add a "Mobile Data Usage" section below storage, per the design mockup. [Source: docs/design/grqaser-app/profile.html]
  - [ ] Display: "This Month" label, total data value (e.g., "1.2 GB"). [Source: docs/design/grqaser-app/profile.html]
  - [ ] Breakdown: "Streaming" (accent dot), "Downloads" (indigo dot), "DB Updates" (muted dot) — each with size value. [Source: docs/design/grqaser-app/profile.html]
  - [ ] Same usage card styling as storage section (no progress bar for data usage, just breakdown). [Source: docs/design/grqaser-app/profile.html]

- [ ] Task 5: Ensure Settings layout order matches mockup (AC: 4)
  - [ ] Verify the Settings/Profile screen sections are ordered per the design mockup: User info → Storage Usage → Mobile Data Usage → Downloads (8.2) → Catalog Databases (8.3) → General Settings (theme, Wi-Fi only). [Source: docs/design/grqaser-app/profile.html]
  - [ ] Ensure existing Settings options (theme toggle, download-over-WiFi-only) are not regressed. [Source: docs/design/grqaser-app/profile.html]

- [ ] Task 6: Write tests (AC: 1–4)
  - [ ] Unit tests for `getStorageUsage()`: mock `appMetaRepository` aggregation calls and platform `getFSInfo()`; verify correct calculation of used, allocated, percentage, and breakdown. [Source: architecture/testing-and-deployment-strategy.md#GrqaserApp]
  - [ ] Unit test: verify storage usage updates after mock download/cleanup/DB change operations. [Source: architecture/testing-and-deployment-strategy.md#GrqaserApp]
  - [ ] Unit tests for `getMobileDataUsage()`: verify per-category and total accumulation. [Source: architecture/testing-and-deployment-strategy.md#GrqaserApp]
  - [ ] Component test for storage/data usage UI: verify correct rendering of progress bar, percentage, breakdown items. [Source: architecture/testing-and-deployment-strategy.md#GrqaserApp]
  - [ ] Run all existing tests and lint; no regressions. [Source: architecture/testing-and-deployment-strategy.md#GrqaserApp]

## Dev Notes

### Dependencies on Previous Stories

- Story 8.1 must be completed: provides `appMetaRepository`, local SQLite infrastructure, TypeScript types (`StorageUsage`).
- Stories 8.2 and 8.3 should be completed or in progress: storage usage reads from `downloaded_mp3s` and `managed_databases` tables populated by those stories. The UI can be built with zero/mock data if those stories are not yet done.

### Architecture — Settings Enrichment (Epic 8)

- Settings displays mobile data usage and storage usage (allocated vs used with percentage). [Source: architecture/grqaserapp-data-integration-and-audio.md#UX-and-navigation]
- Storage metrics stay accurate after downloads, cleanup, or DB changes. [Source: architecture/grqaserapp-data-integration-and-audio.md#UX-and-navigation]
- Storage and mobile data usage are computed at runtime from `downloaded_mp3s` (sum of `file_size_bytes`), `managed_databases` (sum of `file_size_bytes`), and platform APIs for mobile data consumption. No separate table is required. [Source: architecture/data-models-and-schema.md#Notes-on-mobile-schema-management]

### Design Mockup Reference — Settings Usage Sections

Per `docs/design/grqaser-app/profile.html`:

**Storage Usage section:**
- Group title: "Storage Usage" (uppercase, muted)
- Usage card: border, rounded corners, shadow
  - Header: "App Storage" label (left), "248 MB / 1.0 GB" value in accent color (right)
  - Progress bar: 8px height, muted track, teal gradient fill (width = percentage)
  - "24.8% used" text below bar
  - Breakdown items: colored dot + label + value
    - "Downloaded MP3s" (teal dot) — "180 MB"
    - "Databases" (indigo #6366f1 dot) — "52 MB"
    - "Other" (muted dot) — "16 MB"

**Mobile Data Usage section:**
- Group title: "Mobile Data Usage" (uppercase, muted)
- Usage card (same style, no progress bar):
  - Header: "This Month" label, "1.2 GB" total value
  - Breakdown items:
    - "Streaming" (teal dot) — "820 MB"
    - "Downloads" (indigo dot) — "340 MB"
    - "DB Updates" (muted dot) — "40 MB"

**Settings screen order (full):**
1. User info (avatar, Guest, "Local listener")
2. Storage Usage
3. Mobile Data Usage
4. Downloads (Story 8.2)
5. Catalog Databases (Story 8.3)
6. General Settings (Theme: System, Download over Wi-Fi only: On)

### TypeScript Types

`StorageUsage` (in `src/types/book.ts`, defined in Story 8.1):

```typescript
interface StorageUsage {
  allocatedBytes: number;
  usedBytes: number;
  percentage: number;
  breakdown: {
    mp3Bytes: number;
    databaseBytes: number;
    otherBytes: number;
  };
}
```

[Source: architecture/data-models-and-schema.md#TypeScript-client-types]

### Source Tree — New/Modified Files

```
GrqaserApp/src/
├── services/
│   └── storageService.ts         # NEW (or extend downloadManager.ts) — Storage + data usage
├── screens/
│   └── SettingsScreen.tsx        # MODIFIED — Add storage and data usage sections
```

[Source: architecture/source-tree.md#GrqaserApp]

### Technical Constraints

- React Native, TypeScript, Redux Toolkit. [Source: architecture/tech-stack.md#GrqaserApp]
- Platform APIs for storage info: `react-native-fs` `getFSInfo()` or `expo-file-system` `getFreeDiskStorageAsync()`. [Source: architecture/tech-stack.md#GrqaserApp]
- Mobile data usage: platform-dependent; may require native module or manual tracking. [Source: architecture/grqaserapp-data-integration-and-audio.md#UX-and-navigation]
- Format bytes for display (e.g., "248 MB", "1.0 GB", "24.8%"). [Source: docs/design/grqaser-app/profile.html]

### Testing

- **Test location:** `GrqaserApp/__tests__/` or co-located `*.test.ts` files.
- **Frameworks:** Jest, React Native Testing Library. [Source: architecture/tech-stack.md#GrqaserApp]
- **Key tests:** Storage calculation accuracy, breakdown correctness, UI rendering of progress bar and percentages. [Source: architecture/testing-and-deployment-strategy.md#GrqaserApp]
- **Lint:** `npm run lint`. Tests: `npm test`. [Source: architecture/testing-and-deployment-strategy.md#GrqaserApp]

## Change Log

| Date       | Version | Description                    | Author       |
|-----------|---------|--------------------------------|--------------|
| 2026-02-20 | 1.0     | Story created from Epic 8      | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_None yet_

### Completion Notes List

_None yet_

### File List

_None yet_

## QA Results

_None yet_
