# Story 6.1: books-admin-app merge and run

## Status

Draft

## Story

**As an** operator,  
**I want** the crawler and database-viewer merged into a single application (books-admin-app) that I can run locally,  
**so that** I have one entrypoint for all admin and data operations without running two separate apps.

## Acceptance Criteria

1. A new application **books-admin-app** exists; it contains the merged code and behavior of the current crawler and database-viewer.
2. One process starts both the crawler capability and the viewer/API capability (e.g., shared server, or crawler as subprocess/library).
3. Application runs locally only; no authentication is implemented or required.
4. Existing crawler behavior (crawl modes, write to SQLite) and database-viewer behavior (REST API for books/stats/crawler/health, web UI for browse and monitoring) are preserved and accessible from the single app.
5. Configuration (port, logging, etc.) is externalized; DB path is addressed in Story 6.2.

## Tasks / Subtasks

- [ ] Task 1: Create books-admin-app structure (AC: 1)
  - [ ] Add new top-level application `books-admin-app/` in repo; define package.json, entrypoint, and folder layout (e.g. `src/`, `public/` for UI).
  - [ ] Decide and document integration approach: crawler as in-process library vs subprocess; viewer as Express server in same process.
  - [ ] Ensure single process starts both crawler capability and viewer/API ([Source: docs/prd/epic-6.md], [Source: docs/architecture/source-tree.md]).
- [ ] Task 2: Merge crawler capability (AC: 1, 4)
  - [ ] Integrate crawler code (or depend on crawler package/module) so crawler modes (full, update, fix-download-all, full-database, test) and SQLite writes are available ([Source: docs/architecture/crawler-pipeline-and-data-contract.md]).
  - [ ] Preserve crawler config merge (base + environments[NODE_ENV]), DB path from config ([Source: docs/architecture/crawler-pipeline-and-data-contract.md]). DB path selection deferred to 6.2.
  - [ ] Add tests or smoke checks that crawler behavior is preserved (e.g. run mode=test against test DB).
- [ ] Task 3: Merge database-viewer capability (AC: 1, 4)
  - [ ] Integrate viewer API and web UI: REST API for books, stats, crawler status/logs, health; static assets for dashboard, book list, crawler view ([Source: docs/architecture/database-viewer-api-and-deployment.md]).
  - [ ] Ensure same routes and response shapes: `/api/v1/books`, `/api/v1/stats`, `/api/v1/crawler/*`, `/api/v1/health` ([Source: docs/architecture/database-viewer-api-and-deployment.md]).
  - [ ] Run API + UI from same process (e.g. Express serves API and static from `public/`).
- [ ] Task 4: Single process and local-only (AC: 2, 3)
  - [ ] Implement one process that starts Express server and exposes crawler (library or subprocess); no auth; local-only use ([Source: docs/prd/epic-6.md]).
  - [ ] Verify no authentication is implemented or required.
- [ ] Task 5: Externalize configuration (AC: 5)
  - [ ] Externalize port, logging, and other app settings (env or config file); DB path placeholder for Story 6.2 ([Source: docs/architecture/database-viewer-api-and-deployment.md], [Source: docs/architecture/crawler-pipeline-and-data-contract.md]).
  - [ ] Document how to run books-admin-app (e.g. `npm run dev` / `npm start`) and required env vars.

## Dev Notes

### Context

Epic 6 is a brownfield enhancement: consolidate crawler and database-viewer into **books-admin-app**. This story creates the new app and merges both codebases so one process provides crawler + viewer. GrqaserApp and external consumers keep the same data contract; they can point at books-admin-app API if they currently use the database-viewer API ([Source: docs/prd/epic-6.md]).

### Existing systems (to merge)

- **Crawler** (`crawler/`): Entry `crawler/src/crawler.js`; config `crawler/src/config/crawler-config.js`; modes: full, update, fix-download-all, full-database, test; writes to SQLite; schema in `crawler/src/schema/books-table.js` ([Source: docs/architecture/source-tree.md], [Source: docs/architecture/crawler-pipeline-and-data-contract.md]).
- **Database-viewer** (`database-viewer/`): Entry `database-viewer/src/server.js`; routes books, stats, crawler, health; static UI in `database-viewer/public/` ([Source: docs/architecture/source-tree.md], [Source: docs/architecture/database-viewer-api-and-deployment.md]).

### Tech stack (unchanged)

- Node.js LTS, Express 4.x, SQLite, Puppeteer; vanilla JS/HTML/CSS for web UI ([Source: docs/architecture/tech-stack.md]). Reuse existing crawler and database-viewer stack within the merged app ([Source: docs/prd/epic-6.md]).

### File locations

- **New app:** Create `books-admin-app/` at repo root (sibling to `crawler/`, `database-viewer/`, `GrqaserApp/`). Structure: e.g. `books-admin-app/src/` (server, crawler integration, routes), `books-admin-app/public/` (web UI), `books-admin-app/package.json`. Exact layout is implementation choice; keep crawler and viewer modules identifiable for rollback ([Source: docs/prd/epic-6.md Risk mitigation]).

### Compatibility

- Preserve existing crawler behavior (modes, write to SQLite) and database-viewer behavior (REST API, web UI). No regression in data contract or schema for GrqaserApp ([Source: docs/prd/epic-6.md]).

### Testing

- Unit/integration tests per [Source: docs/architecture/testing-and-deployment-strategy.md]: API handlers, config, optional UI tests. Preserve existing crawler and database-viewer tests where applicable; add integration tests for the single app (e.g. start app, hit health + books API, optionally run crawler in test mode).

## Change Log

| Date       | Version | Description                    | Author       |
|-----------|---------|--------------------------------|--------------|
| 2025-02-16 | 1.0     | Story created from Epic 6      | Scrum Master |

## Dev Agent Record

### Agent Model Used

(To be filled by Dev Agent)

### Debug Log References

(To be filled by Dev Agent)

### Completion Notes List

(To be filled by Dev Agent)

### File List

(To be filled by Dev Agent)

## QA Results

(To be filled by QA Agent)
