# Story 8.2: MP3 download storage and offline playback cleanup

## Status

Draft

## Story

**As a** mobile user,
**I want** to allocate storage for downloaded MP3s, download all MP3 files for selected book(s), use the app offline for those books, and clean up storage (all or for selected books) from Settings,
**so that** I can listen without network and manage storage when needed.

## Acceptance Criteria

1. **Storage allocation:** The app allocates and uses local storage for downloaded MP3 files (e.g., per-book or per-title as defined).
2. **Download:** User can request to download all MP3 files for one or more books (e.g., "download all for these 2 books"); download completes and files are stored locally.
3. **Offline use:** When MP3s are downloaded, the user can use the app offline to play those books without network.
4. **Cleanup in Settings:** In Settings, user can clean up downloaded data with options: **clean all** (remove all downloaded MP3s) or **clean for selected book(s)** (remove downloads for chosen books only).
5. After cleanup, playback for removed books falls back to streaming (when online) or shows appropriate offline message; storage usage reflects the change.

## Tasks / Subtasks

- [ ] Task 1: Create download manager service (AC: 1, 2)
  - [ ] Create `src/services/downloadManager.ts` with methods: `downloadBookMp3s(bookId, audioUrls[])`, `deleteBookDownloads(bookId)`, `deleteAllDownloads()`, `getDownloadedBooks()`, `getStorageUsage()`, `isBookDownloaded(bookId)`. [Source: architecture/source-tree.md#GrqaserApp, architecture/grqaserapp-data-integration-and-audio.md#MP3-download-and-offline-playback]
  - [ ] Use `react-native-fs` (or `expo-file-system`) for file download and deletion. Download MP3 files to a dedicated app storage directory (e.g., `{DocumentDirectoryPath}/mp3downloads/{bookId}/`). [Source: architecture/tech-stack.md#GrqaserApp]
  - [ ] Support progress indication per download (callback or observable pattern). Implement retry on failure for individual file downloads. Support background downloads where platform allows. [Source: architecture/grqaserapp-data-integration-and-audio.md#MP3-download-and-offline-playback]
  - [ ] For multi-chapter books, download all chapter MP3s from `chapter_urls` JSON array. For single-file books, download `main_audio_url`. [Source: architecture/data-models-and-schema.md#Books-table]

- [ ] Task 2: Implement `downloaded_mp3s` table in app metadata DB (AC: 1, 2)
  - [ ] Add `downloaded_mp3s` table schema to `src/database/appMetaRepository.ts`: columns `id`, `book_id`, `chapter_index`, `file_path`, `file_size_bytes`, `downloaded_at`, `audio_url`. [Source: architecture/data-models-and-schema.md#downloaded_mp3s]
  - [ ] Implement CRUD methods: `insertDownloadedMp3(entry)`, `getDownloadsByBookId(bookId)`, `getAllDownloads()`, `deleteDownloadsByBookId(bookId)`, `deleteAllDownloads()`, `getTotalDownloadSize()`. [Source: architecture/data-models-and-schema.md#downloaded_mp3s]

- [ ] Task 3: Create download Redux slice (AC: 1, 2, 5)
  - [ ] Create `src/state/slices/downloadSlice.ts` — state: `downloadingBooks` (map of bookId to progress), `downloadedBookIds` (set), `totalStorageUsed` (bytes), `loading`, `error`. Actions: `startDownload`, `updateProgress`, `completeDownload`, `removeDownload`, `removeAllDownloads`, `refreshStorageUsage`. [Source: architecture/source-tree.md#GrqaserApp, architecture/grqaserapp-data-integration-and-audio.md#MP3-download-and-offline-playback]
  - [ ] Async thunks: `downloadBook(bookId)` — fetches audio URLs from catalog DB, calls `downloadManager.downloadBookMp3s()`, updates `appMetaRepository`, dispatches progress/completion. `cleanupBook(bookId)` — calls `downloadManager.deleteBookDownloads()`, updates DB and state. `cleanupAll()` — deletes all. [Source: architecture/grqaserapp-data-integration-and-audio.md#MP3-download-and-offline-playback]
  - [ ] Register slice in store configuration. [Source: architecture/source-tree.md#GrqaserApp]

- [ ] Task 4: Integrate offline playback in audio player (AC: 3, 5)
  - [ ] Update `src/services/playerService.ts` (or `playbackService.ts`): when loading a track for a book, check if local MP3 file exists via `downloadManager.isBookDownloaded(bookId)`. If downloaded, use local file path; otherwise use streaming URL. [Source: architecture/grqaserapp-data-integration-and-audio.md#Audio-stack]
  - [ ] Handle offline state: if no network AND no local MP3, show appropriate offline message (e.g., "This book is not available offline. Download it to listen without internet."). [Source: architecture/grqaserapp-data-integration-and-audio.md#UX-and-navigation]
  - [ ] After cleanup of a currently playing book, stop playback or fall back to streaming if online. [Source: architecture/grqaserapp-data-integration-and-audio.md#MP3-download-and-offline-playback]

- [ ] Task 5: Add download button to BookDetailScreen (AC: 2, 3)
  - [ ] Add a download button to `BookDetailScreen.tsx` per the design mockup: circular teal-outlined button with down-arrow icon and "Download" label, next to the play button. Show "Download all MP3s for offline listening" hint text. [Source: docs/design/grqaser-app/book-detail.html]
  - [ ] Button states: idle (show download icon), downloading (show progress indicator), downloaded (show checkmark or "Downloaded" label), error (show retry). [Source: architecture/grqaserapp-data-integration-and-audio.md#MP3-download-and-offline-playback]
  - [ ] Dispatch `downloadBook(bookId)` on tap; show download progress. [Source: architecture/grqaserapp-data-integration-and-audio.md#MP3-download-and-offline-playback]

- [ ] Task 6: Add downloaded badge to Library items (AC: 3)
  - [ ] In `LibraryScreen.tsx` (or Library list items), show a downloaded badge (teal circle with down-arrow) on the book cover when the book has downloaded MP3s, per the design mockup. [Source: docs/design/grqaser-app/library.html]
  - [ ] Query `downloadSlice` state to determine if each library book is downloaded. [Source: architecture/grqaserapp-data-integration-and-audio.md#MP3-download-and-offline-playback]

- [ ] Task 7: Add download cleanup UI to Settings/Profile screen (AC: 4, 5)
  - [ ] In `SettingsScreen.tsx` (or `ProfileScreen.tsx`), add a "Downloads" section per the design mockup: list of downloaded books with title, size, file count, and a "Clean" button per book; a "Clean All Downloads" danger-outlined button at the bottom; hint text. [Source: docs/design/grqaser-app/profile.html]
  - [ ] "Clean" per book dispatches `cleanupBook(bookId)`; "Clean All" dispatches `cleanupAll()`. After cleanup, the list updates and storage usage reflects changes. [Source: architecture/grqaserapp-data-integration-and-audio.md#MP3-download-and-offline-playback]

- [ ] Task 8: Write tests (AC: 1–5)
  - [ ] Unit tests for `downloadManager.ts`: mock file system; test download, delete per-book, delete all, storage calculation. [Source: architecture/testing-and-deployment-strategy.md#GrqaserApp]
  - [ ] Unit tests for `downloadSlice.ts`: test reducers, actions, async thunks. [Source: architecture/testing-and-deployment-strategy.md#GrqaserApp]
  - [ ] Unit tests for `appMetaRepository.ts` `downloaded_mp3s` CRUD. [Source: architecture/testing-and-deployment-strategy.md#GrqaserApp]
  - [ ] Integration test: download MP3 → verify offline playback path resolution → cleanup → verify fallback to streaming URL. [Source: architecture/testing-and-deployment-strategy.md#GrqaserApp]
  - [ ] Run all existing tests and lint; no regressions. [Source: architecture/testing-and-deployment-strategy.md#GrqaserApp]

## Dev Notes

### Dependency on Story 8.1

Story 8.1 must be completed first. It establishes the local SQLite infrastructure (`database/connection.ts`, `database/catalogRepository.ts`, `database/appMetaRepository.ts`), the `databaseSlice`, Epic 8 TypeScript types, and removes categories. This story builds on that foundation.

### Architecture — MP3 Download and Offline Playback

- **Storage allocation:** Local storage for downloaded MP3 files, tracked per book in `downloaded_mp3s` table. [Source: architecture/grqaserapp-data-integration-and-audio.md#MP3-download-and-offline-playback]
- **Download:** Managed with progress indication, retry on failure, background download support. [Source: architecture/grqaserapp-data-integration-and-audio.md#MP3-download-and-offline-playback]
- **Offline:** Player uses local files when available; streams from URL otherwise. [Source: architecture/grqaserapp-data-integration-and-audio.md#Audio-stack]
- **Cleanup:** "Clean all" deletes all rows and files; "clean per book" deletes rows/files for chosen book(s). After cleanup, fallback to streaming or offline message. [Source: architecture/grqaserapp-data-integration-and-audio.md#MP3-download-and-offline-playback]

### Data Model — `downloaded_mp3s` Table

| Column | Type | Notes |
|--------|------|-------|
| id | TEXT | PRIMARY KEY (UUID or `{book_id}_{chapter_index}`) |
| book_id | TEXT | NOT NULL; references book ID in active catalog DB |
| chapter_index | INTEGER | NULL for single-file books |
| file_path | TEXT | NOT NULL; local file system path |
| file_size_bytes | INTEGER | NOT NULL |
| downloaded_at | TEXT | ISO-8601 |
| audio_url | TEXT | NOT NULL; original streaming URL for re-download/fallback |

Lives in the app metadata SQLite database (`grqaser_app_meta.db`), separate from catalog DBs.

[Source: architecture/data-models-and-schema.md#downloaded_mp3s]

### Audio URL Sources (from Books Table)

- Single-file books: `main_audio_url` column.
- Multi-chapter books: `chapter_urls` column (JSON array of per-chapter audio URLs), `chapter_count` for count.
- `has_chapters` boolean to distinguish.

[Source: architecture/data-models-and-schema.md#Books-table]

### Design Mockup Reference

- **BookDetailScreen download button:** Circular teal-outlined button with down-arrow icon and "Download" label, positioned next to the play button. Hint: "Download all MP3s for offline listening." [Source: docs/design/grqaser-app/book-detail.html]
- **Library downloaded badge:** Teal circle with down-arrow on book cover for downloaded books. [Source: docs/design/grqaser-app/library.html]
- **Settings downloads section:** List of downloaded books (title, size, file count) with per-book "Clean" button and "Clean All Downloads" danger button. Hint: "Remove downloaded MP3s to free storage. Playback falls back to streaming when online." [Source: docs/design/grqaser-app/profile.html]

### Source Tree — New/Modified Files

```
GrqaserApp/src/
├── services/
│   └── downloadManager.ts        # NEW — Download/delete MP3s, storage metrics
├── state/slices/
│   └── downloadSlice.ts          # NEW — MP3 download state
├── database/
│   └── appMetaRepository.ts      # MODIFIED — Add downloaded_mp3s table CRUD
├── services/
│   ├── playerService.ts          # MODIFIED — Check local file before streaming
│   └── playbackService.ts        # MODIFIED — Offline playback integration
├── screens/
│   ├── BookDetailScreen.tsx      # MODIFIED — Add download button
│   ├── LibraryScreen.tsx         # MODIFIED — Add downloaded badge
│   └── SettingsScreen.tsx        # MODIFIED — Add downloads cleanup section
```

[Source: architecture/source-tree.md#GrqaserApp]

### Technical Constraints

- React Native, TypeScript, Redux Toolkit. [Source: architecture/tech-stack.md#GrqaserApp]
- File system: `react-native-fs` or `expo-file-system` for MP3 file management. [Source: architecture/tech-stack.md#GrqaserApp]
- Handle network errors during download with retry and user feedback. [Source: architecture/coding-standards.md#Per-application-notes]
- Offline state detection: check network connectivity before streaming fallback. [Source: architecture/grqaserapp-data-integration-and-audio.md#UX-and-navigation]

### Testing

- **Test location:** `GrqaserApp/__tests__/` or co-located `*.test.ts` files.
- **Frameworks:** Jest, React Native Testing Library. [Source: architecture/tech-stack.md#GrqaserApp]
- **Download manager tests:** Mock file system; test download, delete, storage metrics. [Source: architecture/testing-and-deployment-strategy.md#GrqaserApp]
- **Offline tests:** Verify playback from downloaded MP3s with no network; verify offline messages when streaming unavailable and MP3 not downloaded. [Source: architecture/testing-and-deployment-strategy.md#GrqaserApp]
- **Lint:** `npm run lint`. Tests: `npm test`. [Source: architecture/testing-and-deployment-strategy.md#GrqaserApp]

## Change Log

| Date       | Version | Description                    | Author       |
|-----------|---------|--------------------------------|--------------|
| 2026-02-20 | 1.0     | Story created from Epic 8      | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_None yet_

### Completion Notes List

_None yet_

### File List

_None yet_

## QA Results

_None yet_
