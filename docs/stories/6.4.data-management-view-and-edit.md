# Story 6.4: Data management — view and edit

## Status

Draft

## Story

**As an** operator,  
**I want** to view data from the active database and manually adjust any field for a specific object (e.g. a book),  
**so that** I can correct or enrich data without re-crawling and keep the admin app as the data management surface.

## Acceptance Criteria

1. Data view uses the **active database** (Story 6.2) to display books and related entities (e.g. authors, categories) with list, detail, search, and filters as today.
2. User can **edit any field** for a given object (e.g. book title, author, description, audio URL) and **persist** changes to the active DB.
3. Edits are applied in place (UPDATE); the UI reflects the updated data; no duplicate records created by edit flow.
4. Manual edits are clearly distinguishable from crawler-written data where feasible (e.g. optional “last_edited_at” or source indicator), and safe for local-only use.

## Tasks / Subtasks

- [ ] Task 1: Data view from active DB (AC: 1)
  - [ ] Ensure data view (books list, detail, search, filters; authors/categories as per current schema) reads from the active database only ([Source: docs/architecture/data-models-and-schema.md], Story 6.2).
  - [ ] Reuse or extend existing books/stats API and web UI; no change to read path except that it must use active DB path ([Source: docs/architecture/database-viewer-api-and-deployment.md]).
- [ ] Task 2: Edit any field and persist (AC: 2)
  - [ ] Add API to update a book (e.g. PATCH or PUT /api/v1/books/:id) with editable fields (title, author, description, main_audio_url, etc. per schema) ([Source: docs/architecture/data-models-and-schema.md]).
  - [ ] Implement in-place UPDATE in SQLite; validate types and constraints (e.g. non-empty title, valid URL format for audio URLs) ([Source: docs/architecture/crawler-pipeline-and-data-contract.md] validation rules).
  - [ ] Add UI to edit a book (e.g. detail view with editable form); on save, call update API and refresh view.
  - [ ] Support editing any field documented in schema (title, author, description, duration, category, rating, cover_image_url, main_audio_url, download_url, etc.); persist to active DB.
- [ ] Task 3: In-place UPDATE and no duplicates (AC: 3)
  - [ ] All edits use UPDATE by primary key (id); no INSERT that would create duplicate books ([Source: docs/architecture/data-models-and-schema.md]).
  - [ ] UI reflects updated data after save (refresh detail/list or optimistic update).
- [ ] Task 4: Distinguish manual edits (AC: 4)
  - [ ] Where feasible, distinguish manual edits from crawler data (e.g. add optional `last_edited_at` timestamp or `edited_by`/source indicator column; document in schema or migration) ([Source: docs/prd/epic-6.md]).
  - [ ] Keep scope local-only; no auth required ([Source: docs/prd/epic-6.md]).
- [ ] Task 5: Tests and docs (AC: 1–4)
  - [ ] Add tests for update API (validation, UPDATE only, no duplicates); optional UI tests for edit flow ([Source: docs/architecture/testing-and-deployment-strategy.md]).
  - [ ] Document data management (view + edit) in app docs.

## Dev Notes

### Context

Story 6.4 upgrades the data experience to full data management: view (existing) plus manual edit of any field for a book (or other entities as scoped); persist to active DB; in-place UPDATE; optional last_edited_at/source indicator ([Source: docs/prd/epic-6.md]).

### Prerequisites

- Story 6.1: books-admin-app with merged viewer.
- Story 6.2: Active DB concept; data view and crawler use active path. Edits must write to the same active DB.

### Schema (books)

- Books table: id, title, author, description, duration, duration_formatted, type, language, category, rating, cover_image_url, main_audio_url, download_url, file_size, published_at, created_at, updated_at, is_active, crawl_status, has_chapters, chapter_count, chapter_urls ([Source: docs/architecture/data-models-and-schema.md]). Add optional `last_edited_at` (or similar) if not present; document in data-models-and-schema or migration.

### API

- Existing: GET /api/v1/books, GET /api/v1/books/:id, GET /api/v1/books/search ([Source: docs/architecture/database-viewer-api-and-deployment.md]). New: PATCH or PUT /api/v1/books/:id with body containing editable fields; validate and UPDATE in place.

### File locations

- Within `books-admin-app/`: update route and model for books (write to active DB); UI edit form and save handler in public/ or equivalent. Ensure write path uses active DB only.

### Technical constraints

- Writer: crawler and (from this story) manual edits. Both write to active DB. No duplicate records; use UPDATE by id. Validation rules (required fields, URL format) per crawler validation where applicable ([Source: docs/architecture/crawler-pipeline-and-data-contract.md]).

### Testing

- Unit tests for update validation and UPDATE logic. Integration: edit a book via API, verify DB updated and GET returns new values; verify no duplicate rows ([Source: docs/architecture/testing-and-deployment-strategy.md]).

## Change Log

| Date       | Version | Description                    | Author       |
|-----------|---------|--------------------------------|--------------|
| 2025-02-16 | 1.0     | Story created from Epic 6      | Scrum Master |

## Dev Agent Record

### Agent Model Used

(To be filled by Dev Agent)

### Debug Log References

(To be filled by Dev Agent)

### Completion Notes List

(To be filled by Dev Agent)

### File List

(To be filled by Dev Agent)

## QA Results

(To be filled by QA Agent)
