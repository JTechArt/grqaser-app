# Story 3.3: State management and data integration

## Status

Done

## Story

**As a** developer,  
**I want** state (books, search, user preferences) and data services to be wired to the crawler-backed API or data export,  
**so that** the UI shows real catalog data.

## Acceptance Criteria

1. State management (e.g., Redux Toolkit) is configured with slices for books, audio, user, search.
2. Data services load books (list, by id, search) from the database-viewer API or agreed data source.
3. Loading and error states are handled; data is displayed on Home and Search.

## Tasks / Subtasks

- [x] Task 1: Redux Toolkit and slices (AC: 1)
  - [x] Configure Redux Toolkit with slices for books, audio, user, search ([Source: docs/architecture/grqaserapp-data-integration-and-audio.md], [Source: docs/architecture/tech-stack.md]).
  - [x] Types align with [Source: docs/architecture/data-models-and-schema.md] (e.g. Book type).
- [x] Task 2: Data services and API (AC: 2)
  - [x] Implement data services that load books (list, by id, search) from database-viewer API or agreed data source ([Source: docs/architecture/grqaserapp-data-integration-and-audio.md]).
  - [x] Base URL/config externalized; services used by store or components.
- [x] Task 3: Loading, errors, and display (AC: 3)
  - [x] Handle loading and error states in state and UI; display catalog data on Home and Search ([Source: docs/architecture/grqaserapp-data-integration-and-audio.md], [Source: docs/architecture/coding-standards.md] — clear user feedback for errors).
  - [x] Network failures surfaced to user per NFR4 ([Source: docs/architecture/grqaserapp-data-integration-and-audio.md]).

## Dev Notes

### Previous Story Insights

Stories 3.1 and 3.2 provide project structure and navigation. This story wires state and API so Home and Search show real data; Story 3.4 will refine Home and book detail UI.

### Data Models

- **Books** and API response types aligned with [Source: docs/architecture/data-models-and-schema.md]. Data source: database-viewer REST API (list, by id, search) or agreed export.

### API Specifications

- Consume database-viewer API: `GET /api/v1/books`, `GET /api/v1/books/:id`, `GET /api/v1/books/search?q=...` ([Source: docs/architecture/database-viewer-api-and-deployment.md]). API base URL configurable.

### File Locations

- **State:** `GrqaserApp/src/state/` (or equivalent). **Services:** `GrqaserApp/src/services/`. **Types:** `GrqaserApp/src/types/` ([Source: docs/architecture/source-tree.md]).

### Technical Constraints

- Redux Toolkit; TypeScript; handle network and playback errors with clear user feedback ([Source: docs/architecture/coding-standards.md], [Source: docs/architecture/grqaserapp-data-integration-and-audio.md]).

### Testing

- Unit/integration tests for state and services; mock API where appropriate ([Source: docs/architecture/testing-and-deployment-strategy.md]). Run: `npm test` from `GrqaserApp/`.

## Change Log

| Date       | Version | Description                    | Author       |
|-----------|---------|--------------------------------|--------------|
| 2025-02-14 | 1.0     | Story created from Epic 3     | Scrum Master |
| 2025-02-16 | 1.1     | State, data services, loading/error UI implemented | Dev Agent    |

## Dev Agent Record

### Agent Model Used

Cursor (Auto)

### Debug Log References

- `cd GrqaserApp && npm run type-check` (exit 0)
- `cd GrqaserApp && npm run lint` (exit 0, warnings only)

### Completion Notes List

- Redux Toolkit already had books, player (audio), user slices; search is in books (searchQuery, searchBooks). Added searchLoading and searchError to books slice for Search screen. Types in src/types/book.ts aligned with data-models (Book, BookCategory, BookSearchResult); added bookMapper to map API snake_case and duration (minutes) to app shape (camelCase, duration in seconds).
- Data services: Refactored booksApi to use database-viewer API (GET /api/v1/books, /books/:id, /books/search?q=). Added apiConfig.ts (apiBaseUrl from env API_BASE_URL, default http://localhost:3001/api/v1) and bookMapper.ts (mapApiBookToBook). Parsed response shape { success, data: { books, pagination } }; surface errors via getErrorMessage (used in thunks). env.example updated.
- Loading/error: HomeScreen shows Banner when error is set (dismiss clears error). SearchScreen shows searchLoading spinner, searchError with Dismiss, and FlatList of filteredBooks; runs searchBooks(initialQuery) on mount and on submit; BookCard navigates to BookDetail. Slices use rejectWithValue(getErrorMessage(error)) for user-visible messages.

### File List

- GrqaserApp/src/services/apiConfig.ts (new)
- GrqaserApp/src/services/bookMapper.ts (new)
- GrqaserApp/src/services/booksApi.ts (modified – configurable base, database-viewer paths, mapper, getErrorMessage)
- GrqaserApp/src/state/slices/booksSlice.ts (modified – getErrorMessage, searchLoading/searchError, clearSearchError)
- GrqaserApp/src/screens/HomeScreen.tsx (modified – error Banner, clearError)
- GrqaserApp/src/screens/SearchScreen.tsx (modified – search state, loading/error, results list)
- GrqaserApp/env.example (modified – API_BASE_URL default for database-viewer)
- GrqaserApp/__tests__/services/bookMapper.test.ts (new)

## QA Results

### Review Date: 2025-02-16

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation meets all acceptance criteria. Redux Toolkit is configured with books (including search state), player (audio), and user slices; types align with data-models. Data services (booksApi, apiConfig, bookMapper) load books list, by id, and search from database-viewer API; base URL is externalized via API_BASE_URL (env). Loading and error states are handled: HomeScreen shows loading spinner and error Banner with Dismiss; SearchScreen shows searchLoading, searchError with Dismiss, and FlatList of results. Catalog data is displayed on Home (stats, categories, featured books) and Search (search results). Type-check and lint pass; bookMapper unit tests pass (run with `--config jest.config.js` due to duplicate Jest config in project).

### Refactoring Performed

None. Implementation is consistent with architecture and coding standards.

### Compliance Check

- Coding Standards: ✓ TypeScript; Redux Toolkit; service layer; network/error feedback per NFR4.
- Project Structure: ✓ State under src/state/, services under src/services/, types in src/types/.
- Testing Strategy: ✓ Unit test for bookMapper; story allows mock API; Jest config conflict noted below.
- All ACs Met: ✓ AC1 slices (books, audio, user, search in books); AC2 API services + config; AC3 loading/error/display on Home and Search.

### Improvements Checklist

- [x] No refactors required for this story.
- [ ] Resolve duplicate Jest config (jest.config.js and package.json "jest" key) so `npm test` runs without --config (CONCERNS only; tests pass with explicit config).

### Security Review

API base URL from env; no secrets in code. Acceptable for this story.

### Performance Considerations

Categories are derived client-side from full book list (getCategories); acceptable for MVP. Pagination used in getBooks/searchBooks.

### Files Modified During Review

None.

### Gate Status

Gate: PASS → docs/qa/gates/3.3-state-management-and-data-integration.yml

### Recommended Status

✓ Ready for Done

