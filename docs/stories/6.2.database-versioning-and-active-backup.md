# Story 6.2: Database versioning and active/backup

## Status

Draft

## Story

**As an** operator,  
**I want** to define database paths by version (e.g. db.v1, db.v2) with one active database and the rest as backups that I can promote or delete,  
**so that** crawler data goes to the active DB and the data view always shows the active DB, with clear backup management.

## Acceptance Criteria

1. The concept of **db.{version}** (or equivalent path naming) is supported; the user can set the active database path (e.g. which db.vX is active).
2. **Only one database is active at a time.** All other known DBs are treated as backups.
3. When the active DB path is changed, **new crawler runs write to the new active path**; the data view **reads from the active path** to show data.
4. User can **mark a backup as active** (switching which DB is active) and can **physically delete** a backup DB.
5. UI or API exposes: list of known DBs (active + backups), set active, delete backup; data view and crawler consistently use the active DB path.

## Tasks / Subtasks

- [ ] Task 1: Model and store active/backup DB state (AC: 1, 2)
  - [ ] Introduce concept of db.{version} (or equivalent path naming); store “active” DB path and list of known backup paths in config or small metadata store (e.g. JSON/file or SQLite registry).
  - [ ] Enforce single active DB: only one path is active; all others are backups ([Source: docs/prd/epic-6.md]).
  - [ ] Load/save active path so crawler and data view can read it ([Source: docs/prd/epic-6.md]).
- [ ] Task 2: Wire crawler and data view to active path (AC: 3)
  - [ ] Crawler runs use the current active DB path for all writes ([Source: docs/architecture/crawler-pipeline-and-data-contract.md]).
  - [ ] Data view (books, stats, crawler read-only APIs) read from the active DB path ([Source: docs/architecture/database-viewer-api-and-deployment.md]).
  - [ ] When active path is changed, subsequent crawler runs and data view use the new path without restart if feasible, or document restart requirement.
- [ ] Task 3: Promote backup to active and delete backup (AC: 4)
  - [ ] Implement “set active”: user can mark a backup as active (update active path; previous active becomes backup).
  - [ ] Implement “delete backup”: physically remove a backup DB file (or mark as deleted); do not allow deleting the active DB.
  - [ ] Validate operations (e.g. active must exist; delete only backups).
- [ ] Task 4: Expose DB list and actions in UI or API (AC: 5)
  - [ ] Expose list of known DBs (active + backups) via API and/or web UI.
  - [ ] Expose “set active” and “delete backup” via API and/or UI; data view and crawler consistently use the active DB path after changes.
- [ ] Task 5: Tests and docs (AC: 1–5)
  - [ ] Add tests for active/backup logic, set active, delete backup, and that crawler/view use active path ([Source: docs/architecture/testing-and-deployment-strategy.md]).
  - [ ] Document DB versioning (how to add/promote/delete DBs) in app docs.

## Dev Notes

### Context

Story 6.2 builds on books-admin-app (Story 6.1). It adds database versioning: one active DB, rest backups; crawler writes to active; data view reads from active; user can promote backup to active and delete backups ([Source: docs/prd/epic-6.md]).

### Prerequisites

- books-admin-app exists; single process runs crawler + viewer; config externalized (Story 6.1). DB path was deferred to this story ([Source: docs/stories/6.1.books-admin-app-merge-and-run.md]).

### Data contract

- Schema remains per [Source: docs/architecture/data-models-and-schema.md]. Only the DB *path* (and which path is “active”) changes; schema of each db.vX is the same.

### File locations

- Implement within `books-admin-app/`: config or registry for active + backup paths; API routes for list/set-active/delete-backup; UI screens or sections for DB management. Reuse existing viewer data layer pointed at active path.

### Technical constraints

- Only one active DB at a time. Deleting the active DB must be prevented or require explicit “clear active” flow. Crawler and viewer must never point at different DBs for normal operation ([Source: docs/prd/epic-6.md]).

### Testing

- Unit tests for active/backup state and operations. Integration tests: set active, run crawler write, verify data view shows new DB; delete backup only ([Source: docs/architecture/testing-and-deployment-strategy.md]).

## Change Log

| Date       | Version | Description                    | Author       |
|-----------|---------|--------------------------------|--------------|
| 2025-02-16 | 1.0     | Story created from Epic 6      | Scrum Master |

## Dev Agent Record

### Agent Model Used

(To be filled by Dev Agent)

### Debug Log References

(To be filled by Dev Agent)

### Completion Notes List

(To be filled by Dev Agent)

### File List

(To be filled by Dev Agent)

## QA Results

(To be filled by QA Agent)
